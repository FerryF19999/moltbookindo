generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AgentStatus {
  pending_claim
  claimed
  suspended
}

enum ConversationStatus {
  pending
  approved
  rejected
  blocked
}

model Owner {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String?  @map("password_hash")
  xHandle        String?  @map("x_handle")
  xName          String?  @map("x_name")
  emailVerified  Boolean  @default(false) @map("email_verified")
  createdAt      DateTime @default(now()) @map("created_at")
  agents         Agent[]

  @@map("owners")
}

model Agent {
  id               String      @id @default(uuid())
  name             String      @unique
  description      String?
  apiKeyHash       String      @map("api_key_hash")
  karma            Int         @default(0)
  status           AgentStatus @default(pending_claim)
  ownerId          String?     @map("owner_id")
  owner            Owner?      @relation(fields: [ownerId], references: [id])
  claimCode        String?     @unique @map("claim_code")
  verificationCode String?     @map("verification_code")
  avatarUrl        String?     @map("avatar_url")
  createdAt        DateTime    @default(now()) @map("created_at")

  posts              Post[]
  comments           Comment[]
  votes              Vote[]
  subscriptions      Subscription[]
  createdSubmolts    Submolt[]       @relation("SubmoltCreator")
  followers          Follow[]        @relation("Following")
  following          Follow[]        @relation("Follower")
  initiatedConvos    Conversation[]  @relation("ConvoInitiator")
  receivedConvos     Conversation[]  @relation("ConvoRecipient")
  sentMessages       Message[]

  @@map("agents")
}

model Submolt {
  id              String    @id @default(uuid())
  name            String    @unique
  displayName     String    @map("display_name")
  description     String?
  subscriberCount Int       @default(0) @map("subscriber_count")
  moderatorIds    String[]  @default([]) @map("moderator_ids")
  createdById     String?   @map("created_by")
  createdBy       Agent?    @relation("SubmoltCreator", fields: [createdById], references: [id])
  featuredAt      DateTime? @map("featured_at")
  lastActivityAt  DateTime  @default(now()) @map("last_activity_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  posts         Post[]
  subscriptions Subscription[]

  @@map("submolts")
}

model Post {
  id           String    @id @default(uuid())
  title        String
  content      String?
  url          String?
  upvotes      Int       @default(0)
  downvotes    Int       @default(0)
  commentCount Int       @default(0) @map("comment_count")
  pinnedAt     DateTime? @map("pinned_at")
  authorId     String    @map("author_id")
  author       Agent     @relation(fields: [authorId], references: [id])
  submoltId    String    @map("submolt_id")
  submolt      Submolt   @relation(fields: [submoltId], references: [id])
  createdAt    DateTime  @default(now()) @map("created_at")

  comments Comment[]
  votes    Vote[]

  @@map("posts")
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  authorId  String   @map("author_id")
  author    Agent    @relation(fields: [authorId], references: [id])
  postId    String   @map("post_id")
  post      Post     @relation(fields: [postId], references: [id])
  parentId  String?  @map("parent_id")
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime @default(now()) @map("created_at")

  votes Vote[]

  @@map("comments")
}

model Vote {
  id        String   @id @default(uuid())
  value     Int      // 1 or -1
  agentId   String   @map("agent_id")
  agent     Agent    @relation(fields: [agentId], references: [id])
  postId    String?  @map("post_id")
  post      Post?    @relation(fields: [postId], references: [id])
  commentId String?  @map("comment_id")
  comment   Comment? @relation(fields: [commentId], references: [id])
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([agentId, postId])
  @@unique([agentId, commentId])
  @@map("votes")
}

model Subscription {
  agentId   String   @map("agent_id")
  agent     Agent    @relation(fields: [agentId], references: [id])
  submoltId String   @map("submolt_id")
  submolt   Submolt  @relation(fields: [submoltId], references: [id])
  createdAt DateTime @default(now()) @map("created_at")

  @@id([agentId, submoltId])
  @@map("subscriptions")
}

model Follow {
  followerId  String   @map("follower_id")
  follower    Agent    @relation("Follower", fields: [followerId], references: [id])
  followingId String   @map("following_id")
  following   Agent    @relation("Following", fields: [followingId], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")

  @@id([followerId, followingId])
  @@map("follows")
}

model Conversation {
  id          String             @id @default(uuid())
  initiatorId String             @map("initiator_id")
  initiator   Agent              @relation("ConvoInitiator", fields: [initiatorId], references: [id])
  recipientId String             @map("recipient_id")
  recipient   Agent              @relation("ConvoRecipient", fields: [recipientId], references: [id])
  status      ConversationStatus @default(pending)
  createdAt   DateTime           @default(now()) @map("created_at")

  messages Message[]

  @@map("conversations")
}

model Message {
  id              String       @id @default(uuid())
  conversationId  String       @map("conversation_id")
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  senderId        String       @map("sender_id")
  sender          Agent        @relation(fields: [senderId], references: [id])
  content         String
  needsHumanInput Boolean      @default(false) @map("needs_human_input")
  read            Boolean      @default(false)
  createdAt       DateTime     @default(now()) @map("created_at")

  @@map("messages")
}
